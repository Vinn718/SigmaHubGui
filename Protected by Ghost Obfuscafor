-- Services
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local Remote = game:GetService("ReplicatedStorage").RemoteEvents.RequestTakeDiamonds

-- Tunggu sampai benar-benar di dalam game
repeat
    task.wait(0.5)
until LocalPlayer:FindFirstChild("PlayerGui") 
   and LocalPlayer.PlayerGui:FindFirstChild("Interface") 
   and workspace:FindFirstChild("Items")

-- PlayerGui & Diamond
local Interface = LocalPlayer.PlayerGui:WaitForChild("Interface")
local DiamondCount = Interface:WaitForChild("DiamondCount"):WaitForChild("Count")

-- Fullscreen GUI
local ScreenGui = Instance.new("ScreenGui", CoreGui)
ScreenGui.Name = "ChatGPT_FarmDiamond"

local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(1,0,1,0)
Frame.BackgroundColor3 = Color3.new(0,0,0)
Frame.BackgroundTransparency = 0.5
Frame.BorderSizePixel = 0

local Title = Instance.new("TextLabel", Frame)
Title.Size = UDim2.new(1,0,0,50)
Title.Position = UDim2.new(0,0,0,0)
Title.BackgroundTransparency = 1
Title.Text = "ChatGPT | Farm Diamond"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 30
Title.TextColor3 = Color3.new(1,1,1)

local DiamondLabel = Instance.new("TextLabel", Frame)
DiamondLabel.Size = UDim2.new(1,0,0,50)
DiamondLabel.Position = UDim2.new(0,0,0,50)
DiamondLabel.BackgroundTransparency = 1
DiamondLabel.Font = Enum.Font.GothamBold
DiamondLabel.TextSize = 25
DiamondLabel.TextColor3 = Color3.new(1,1,0)

-- Update diamond count
task.spawn(function()
    while task.wait(0.2) do
        DiamondLabel.Text = "Diamonds: "..DiamondCount.Text
    end
end)

-- Hop server retry
local function hopServer()
    local gameId = game.PlaceId
    local tried = {}

    while true do
        local cursor = ""
        local success, body, teleported = false, nil, false

        repeat
            local url = string.format("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100%s",
                gameId, cursor ~= "" and "&cursor=" .. cursor or "")

            success, body = pcall(function()
                return game:HttpGet(url)
            end)

            if success then
                local data = HttpService:JSONDecode(body)
                for _, server in ipairs(data.data) do
                    if server.playing < server.maxPlayers and server.id ~= game.JobId and not tried[server.id] then
                        tried[server.id] = true
                        local tpSuccess, err = pcall(function()
                            TeleportService:TeleportToPlaceInstance(gameId, server.id, LocalPlayer)
                        end)
                        if tpSuccess then
                            print("Teleporting to server:", server.id)
                            teleported = true
                            break
                        else
                            warn("Teleport gagal:", err)
                        end
                    end
                end
                if data.nextPageCursor then
                    cursor = data.nextPageCursor
                else
                    break
                end
            else
                warn("Gagal ambil daftar server, retry 5 detik...")
                task.wait(5)
            end
        until success

        if teleported then break end
        task.wait(3)
    end
end

-- Auto farm chest & diamond
local function farmDiamonds()
    repeat task.wait() until LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")

    local function openChest(chest)
        if not chest or not chest.Parent then return end
        local hrp = LocalPlayer.Character.HumanoidRootPart
        hrp.CFrame = chest:GetPivot() -- teleport instant ke chest

        local proxPrompt
        local main = chest:FindFirstChild("Main")
        if main and main:FindFirstChild("ProximityAttachment") then
            proxPrompt = main.ProximityAttachment:FindFirstChild("ProximityInteraction")
        end

        if proxPrompt then
            local startTime = tick()
            while proxPrompt.Parent and (tick()-startTime)<5 do
                pcall(function()
                    fireproximityprompt(proxPrompt)
                end)
                task.wait(0.05)
            end
        end
    end

    -- Buka semua chest
    for _, chest in pairs(workspace.Items:GetChildren()) do
        if chest.Name:find("Chest") or chest.Name:find("Diamond") then
            openChest(chest)
        end
    end

    task.wait(0.5)

    -- Ambil semua diamond
    for _, v in pairs(workspace:GetDescendants()) do
        if v.ClassName == "Model" and v.Name == "Diamond" then
            pcall(function()
                Remote:FireServer(v)
            end)
        end
    end
end

-- Auto hop jika mati (langsung hop stabil)
local function connectDeathHop()
    local function onHumanoidDied()
        task.wait(0.5) -- pastikan benar-benar mati
        hopServer()
    end

    if LocalPlayer.Character then
        local humanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.Died:Connect(onHumanoidDied)
        end
    end

    LocalPlayer.CharacterAdded:Connect(function(char)
        local humanoid = char:WaitForChild("Humanoid")
        humanoid.Died:Connect(onHumanoidDied)
    end)
end

connectDeathHop()

-- Main loop
while true do
    local success, err = pcall(farmDiamonds)
    if not success then
        warn("Farming error:", err)
    end
    task.wait(1)
    hopServer()
end
